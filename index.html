<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/walkermatt/ol3-layerswitcher/master/src/ol3-layerswitcher.css" type="text/css">
    <style>
      html, body, .map {
        margin: 0;
        height: 100%;
        width: 100%;
        background-color: #a3ccff;
      }
      .colorpicker {
        top: 1em;
        right: .5em;
      }
      .colorpicker button {
        width: auto;
        display: inline-block;
        padding: 1px 6px;
      }
      .colorpicker .block {
        width: 10px;
        height: 10px;
        display: inline-block;
      }
    </style>
    <script src="https://openlayers.org/en/v3.19.1/build/ol-debug.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/walkermatt/ol3-layerswitcher/master/src/ol3-layerswitcher.js" type="text/javascript"></script>
    <title>New Zealand Index of Multiple Deprivation Map</title>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script type="text/javascript">
      // Generate layers

      var layers = {
        "Income": "IncomeRank",
        "Housing": "HouseRank",
        "Health": "HlthRank",
        "Employment": "EmpRank",
        "Education": "EduRank",
        "Crime": "CrimeRank",
        "Access": "AccRank",
        "IMD": "NZIMDRank",
      }
      var color = 'BuPu';
      var extent = [17745294.397799145, -6212398.735764966, 21273479.234843332, -3501802.3644446055];

      var ol_layers = []
      for (var l in layers) {
        var machine_name = layers[l];
        var layer = new ol.layer.Tile({
          title: l,
          machine_name: machine_name,
          //type: 'base',
          source: new ol.source.XYZ({
            url: 'tiles/' + color + '_' + machine_name + '/{z}/{x}/{y}.png'
          }),
          extent: extent,
          opacity: 1,
          visible: l == 'IMD'
        });
        ol_layers.push(layer);
        var setBlendMode = function(evt) {
          evt.context.globalCompositeOperation = 'multiply';
        }
        var resetBlendMode = function(evt) {
          evt.context.globalCompositeOperation = 'source-over';
        }
        layer.on('precompose', setBlendMode);
        layer.on('postcompose', resetBlendMode);
      }

      // Setup color control

      var ToggleColorControl = function(opt_options) {

        var options = opt_options || {};

        colors = {
          'BuPu': ['#edf8fb','#bfd3e6','#9ebcda','#8c96c6','#8856a7','#810f7c'],
          'OrRd': ['#fef0d9','#fdd49e','#fdbb84','#fc8d59','#e34a33','#b30000'],
          'RdYlGn': ['#d73027','#fc8d59','#fee08b','#d9ef8b','#91cf60','#1a9850']
        }
        
        var buttons = []
        
        var parent = document.createElement('div');
        parent.className = 'colorpicker ol-unselectable ol-control';
        
        var handleClick = function() {
          var color = this.id;
          var layers = map.getLayers().getArray()[0].getLayers().getArray();
          for (var i in layers) {
            var l = layers[i];
            if (!l.getVisible()) continue;
            var machine_name = l.getProperties().machine_name;
            var new_source = new ol.source.XYZ({
              url: 'tiles/' + color + '_' + machine_name + '/{z}/{x}/{y}.png'
            })
            l.setSource(new_source);
          }
        };
        
        for (var c in colors) {
          var button = document.createElement('button');
          button.id = c;
          for (var i in colors[c]) {
            var block = document.createElement('div')
            block.className = 'block';
            block.style.backgroundColor = colors[c][i];
            button.appendChild(block);
          }
          button.addEventListener('click', handleClick, false);
          button.addEventListener('touchstart', handleClick, false);
          parent.appendChild(button);
        }

        ol.control.Control.call(this, {
          element: parent,
          target: options.target
        });

      };
      ol.inherits(ToggleColorControl, ol.control.Control);

      var dragAndDropInteraction = new ol.interaction.DragAndDrop({
        formatConstructors: [
          ol.format.GPX,
          ol.format.GeoJSON,
          ol.format.IGC,
          ol.format.KML,
          ol.format.TopoJSON
        ]
      });

      var overlayGroup = new ol.layer.Group({
        'title': 'Overlays',
        zIndex: 10,
        layers: [
          new ol.layer.Tile({
            title: 'Residential area',
            source: new ol.source.XYZ({
              url: 'tiles/LINZ_Residential/{z}/{x}/{y}.png',
              attributions: '<br>Residential area data sourced from the <a href="https://data.linz.govt.nz/layer/325-nz-residential-area-polygons-topo-150k/">LINZ Data Service</a>'
            }),
            extent: extent,
            visible: false
          }),
          new ol.layer.Vector({
            title: 'DHB Zones',
            source: new ol.source.Vector({
              url: 'nz_dhb/nz-district-health-boards-2012.kml',
              attributions: '<br>DHB area data sourced from the <a href="https://koordinates.com/layer/4324-nz-district-health-boards-2012/">Ministry of Health</a>',
              format: new ol.format.KML({extractStyles: false})
            }),
            extent: extent,
            style: new ol.style.Style({
              fill: new ol.style.Fill ({
                color: "transparent"
              }),
              stroke: new ol.style.Stroke({
                color: "blue",
                width: 2
              })
            }),
            visible: false
          }),
          new ol.layer.Tile({
            title: 'City labels',
            source: new ol.source.Stamen({
              layer: 'toner-labels',
            }),
            extent: extent,
            opacity: .5
          })
        ]
      });

      var layerswitcher = new ol.control.LayerSwitcher();

      var map = new ol.Map({
        controls: ol.control.defaults().extend([
          new ol.control.ScaleLine(),
          new ol.control.ZoomSlider(),
          layerswitcher,
          new ToggleColorControl()
        ]),
        target: 'map',
        interactions: ol.interaction.defaults().extend([
          dragAndDropInteraction
        ]),
        layers: [
          new ol.layer.Group({
            'title': 'Index of Multiple Deprivation',
            layers: ol_layers
          }),
          overlayGroup
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([173, -40]),
          zoom: 6,
          minZoom: 6,
          maxZoom: 19,
          extent: extent
        })
      });

      dragAndDropInteraction.on('addfeatures', function(event) {
        console.log(event);
        var vectorSource = new ol.source.Vector({
          features: event.features
        });
        overlayGroup.getLayers().push(new ol.layer.Vector({
          title: event.file.name,
          source: vectorSource,
          //style: styleFunction
        }));
        map.getView().fit(
            vectorSource.getExtent(), /** @type {ol.Size} */ (map.getSize())
        );
      });
    </script>
  </body>
</html>
